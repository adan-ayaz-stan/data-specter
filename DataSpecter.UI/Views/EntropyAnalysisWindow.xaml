<Window x:Class="DataSpecter.UI.Views.EntropyAnalysisWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="clr-namespace:DataSpecter.UI.Converters" mc:Ignorable="d" Title="Entropy Analysis" Height="700" Width="1000" Background="{StaticResource Brush.Panel.Background}" WindowStartupLocation="CenterOwner" ResizeMode="CanResize">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:EntropyHeightConverter x:Key="EntropyHeightConverter"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="ENTROPY ANALYSIS" FontSize="24" FontWeight="Bold" Foreground="{StaticResource Brush.Action.Primary}"/>
            <TextBlock Text="{Binding FileName}" FontSize="14" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,5,0,0"/>
            <TextBlock Text="{Binding FileSize}" FontSize="12" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,2,0,0"/>
        </StackPanel>

        <!-- Progress -->
        <Border Grid.Row="1" Background="#111" BorderBrush="{StaticResource Brush.Action.Primary}" BorderThickness="1" Padding="15" Margin="0,0,0,20" Visibility="{Binding IsCalculating, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel>
                <TextBlock Text="{Binding CalculationStatus}" Foreground="{StaticResource Brush.Text.Primary}" FontSize="12" Margin="0,0,0,10"/>
                <ProgressBar Value="{Binding CalculationProgress}" Maximum="100" Height="8" Background="#333" Foreground="{StaticResource Brush.Action.Primary}"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="2" Visibility="{Binding HasResults, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left: Charts -->
            <Border Grid.Column="0" Background="#0a0a0a" BorderBrush="{StaticResource Brush.Action.Primary}" BorderThickness="1" Margin="0,0,10,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="15">
                        <!-- Entropy Chart -->
                        <TextBlock Text="SHANNON ENTROPY DISTRIBUTION" FontSize="12" FontWeight="Bold" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,10"/>

                        <Border Height="250" Background="Black" BorderBrush="{StaticResource Brush.Panel.Border}" BorderThickness="1" Padding="5" Margin="0,0,0,20">
                            <Grid>
                                <!-- Entropy bars -->
                                <ItemsControl ItemsSource="{Binding EntropyData}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Rows="1"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Rectangle Fill="{StaticResource Brush.Action.Primary}" VerticalAlignment="Bottom" Margin="0,0,0.5,0" ToolTip="{Binding}">
                                                <Rectangle.Height>
                                                    <MultiBinding Converter="{StaticResource EntropyHeightConverter}">
                                                        <Binding/>
                                                        <Binding RelativeSource="{RelativeSource AncestorType=Border}" Path="ActualHeight"/>
                                                    </MultiBinding>
                                                </Rectangle.Height>
                                            </Rectangle>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Y-axis labels -->
                                <StackPanel HorizontalAlignment="Left" VerticalAlignment="Stretch" Margin="2,5,0,5">
                                    <TextBlock Text="8.0" Foreground="{StaticResource Brush.Text.Muted}" FontSize="9" FontFamily="Consolas"/>
                                    <TextBlock Text="6.0" Foreground="{StaticResource Brush.Text.Muted}" FontSize="9" FontFamily="Consolas" Margin="0,35,0,0"/>
                                    <TextBlock Text="4.0" Foreground="{StaticResource Brush.Text.Muted}" FontSize="9" FontFamily="Consolas" Margin="0,35,0,0"/>
                                    <TextBlock Text="2.0" Foreground="{StaticResource Brush.Text.Muted}" FontSize="9" FontFamily="Consolas" Margin="0,35,0,0"/>
                                    <TextBlock Text="0.0" Foreground="{StaticResource Brush.Text.Muted}" FontSize="9" FontFamily="Consolas" Margin="0,35,0,0"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Byte Frequency Distribution -->
                        <TextBlock Text="BYTE FREQUENCY DISTRIBUTION (0x00 - 0xFF)" FontSize="12" FontWeight="Bold" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,10"/>

                        <Border Height="200" Background="Black" BorderBrush="{StaticResource Brush.Panel.Border}" BorderThickness="1" Padding="5">
                            <ItemsControl ItemsSource="{Binding ByteFrequencies}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <UniformGrid Rows="1"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Rectangle VerticalAlignment="Bottom" Margin="0,0,0.2,0" ToolTip="{Binding}">
                                            <Rectangle.Fill>
                                                <LinearGradientBrush StartPoint="0,1" EndPoint="0,0">
                                                    <GradientStop Color="#00FFAA" Offset="0"/>
                                                    <GradientStop Color="#0088FF" Offset="1"/>
                                                </LinearGradientBrush>
                                            </Rectangle.Fill>
                                            <Rectangle.Height>
                                                <MultiBinding Converter="{StaticResource EntropyHeightConverter}">
                                                    <Binding/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=Border}" Path="ActualHeight"/>
                                                </MultiBinding>
                                            </Rectangle.Height>
                                        </Rectangle>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Right: Statistics & Analysis -->
            <Border Grid.Column="1" Background="#0a0a0a" BorderBrush="{StaticResource Brush.Action.Primary}" BorderThickness="1">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="15">
                        <!-- Statistics -->
                        <TextBlock Text="STATISTICS" FontSize="12" FontWeight="Bold" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,10"/>

                        <Grid Margin="0,0,0,20">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="Average:" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,0,10,5"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding AverageEntropy, StringFormat={}{0:F4}}" Foreground="{StaticResource Brush.Action.Primary}" FontWeight="Bold" Margin="0,0,0,5"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Minimum:" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,0,10,5"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding MinEntropy, StringFormat={}{0:F4}}" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,5"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Maximum:" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,0,10,5"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding MaxEntropy, StringFormat={}{0:F4}}" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,5"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Std Dev:" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,0,10,5"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding StdDevEntropy, StringFormat={}{0:F4}}" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,5"/>

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Chunks:" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,0,10,5"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding ChunkCount, StringFormat={}{0:N0}}" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,5"/>

                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Chunk Size:" Foreground="{StaticResource Brush.Text.Muted}" Margin="0,0,10,5"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding ChunkSize}" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,5"/>
                        </Grid>

                        <!-- File Insights -->
                        <TextBlock Text="FILE INSIGHTS" FontSize="12" FontWeight="Bold" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,10"/>

                        <Border Background="#111" BorderBrush="{StaticResource Brush.Panel.Border}" BorderThickness="1" Padding="10" Margin="0,0,0,20">
                            <StackPanel>
                                <TextBlock Text="{Binding CompressionHint}" Foreground="{StaticResource Brush.Text.Primary}" TextWrapping="Wrap" FontSize="11" Margin="0,0,0,8"/>
                                <TextBlock Text="{Binding EncryptionHint}" Foreground="{StaticResource Brush.Text.Primary}" TextWrapping="Wrap" FontSize="11" Margin="0,0,0,8"/>
                                <TextBlock Text="{Binding DataTypeHint}" Foreground="{StaticResource Brush.Text.Primary}" TextWrapping="Wrap" FontSize="11"/>
                            </StackPanel>
                        </Border>

                        <!-- Export Options -->
                        <TextBlock Text="EXPORT" FontSize="12" FontWeight="Bold" Foreground="{StaticResource Brush.Text.Primary}" Margin="0,0,0,10"/>

                        <Button Command="{Binding ExportCsvCommand}" Content="ðŸ“Š EXPORT CSV" Padding="15,10" Margin="0,0,0,5" FontWeight="Bold" ToolTip="Export entropy data to CSV file"/>

                        <Button Command="{Binding ExportReportCommand}" Content="ðŸ“„ EXPORT REPORT" Padding="15,10" FontWeight="Bold" ToolTip="Export detailed analysis report"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Footer Buttons -->
        <Border Grid.Row="3" BorderBrush="{StaticResource Brush.Panel.Border}" BorderThickness="0,1,0,0" Padding="0,20,0,0" Margin="0,20,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Command="{Binding RecalculateCommand}" Content="ðŸ”„ RECALCULATE" Padding="15,8" Margin="0,0,10,0" FontWeight="Bold" Visibility="{Binding HasResults, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                <Button Content="CLOSE" Click="CloseButton_Click" Padding="20,8" FontWeight="Bold"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
